<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-instruction-execution-cpi" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Instruction Execution (CPI) | Goki Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://stayrar3.github.io/doc_goki/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://stayrar3.github.io/doc_goki/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://stayrar3.github.io/doc_goki/docs/instruction-execution-cpi"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Instruction Execution (CPI) | Goki Documentation"><meta data-rh="true" name="description" content="Welcome back, Goki explorers! In our previous chapter, Transaction State Account, we learned that the Smart Wallet Program stores all the details of a proposed transaction, including the actual instructions to be performed, in a special Transaction State Account. But how does the Smart Wallet actually perform those instructions? It&#x27;s not like the Smart Wallet itself is a general-purpose computer that can just &quot;do&quot; anything."><meta data-rh="true" property="og:description" content="Welcome back, Goki explorers! In our previous chapter, Transaction State Account, we learned that the Smart Wallet Program stores all the details of a proposed transaction, including the actual instructions to be performed, in a special Transaction State Account. But how does the Smart Wallet actually perform those instructions? It&#x27;s not like the Smart Wallet itself is a general-purpose computer that can just &quot;do&quot; anything."><link data-rh="true" rel="icon" href="/doc_goki/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://stayrar3.github.io/doc_goki/docs/instruction-execution-cpi"><link data-rh="true" rel="alternate" href="https://stayrar3.github.io/doc_goki/docs/instruction-execution-cpi" hreflang="en"><link data-rh="true" rel="alternate" href="https://stayrar3.github.io/doc_goki/docs/instruction-execution-cpi" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Instruction Execution (CPI)","item":"https://stayrar3.github.io/doc_goki/docs/instruction-execution-cpi"}]}</script><link rel="alternate" type="application/rss+xml" href="/doc_goki/blog/rss.xml" title="Goki Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/doc_goki/blog/atom.xml" title="Goki Documentation Atom Feed"><link rel="stylesheet" href="/doc_goki/assets/css/styles.ba795a2b.css">
<script src="/doc_goki/assets/js/runtime~main.439b40e7.js" defer="defer"></script>
<script src="/doc_goki/assets/js/main.7d543981.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/doc_goki/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/doc_goki/"><div class="navbar__logo"><img src="/doc_goki/img/logo.svg" alt="Goki Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/doc_goki/img/logo.svg" alt="Goki Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Goki Documentation</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/doc_goki/docs/intro">Documentation</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/stayrar3/doc_goki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/intro">Introduction to Goki</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/smart-wallet-wrapper">SmartWalletWrapper</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/owners-threshold">Owners &amp; Threshold</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/timelock">Timelock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/goki-sdk">Goki SDK</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/transaction-state-account">Transaction State Account</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/doc_goki/docs/instruction-execution-cpi">Instruction Execution (CPI)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc_goki/docs/program-derived-addresses-pdas">Program Derived Addresses (PDAs)</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/doc_goki/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Instruction Execution (CPI)</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Instruction Execution (CPI)</h1></header>
<p>Welcome back, Goki explorers! In our previous chapter, <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a>, we learned that the Smart Wallet Program stores all the details of a proposed transaction, including the actual instructions to be performed, in a special <code>Transaction State Account</code>. But how does the Smart Wallet actually <em>perform</em> those instructions? It&#x27;s not like the Smart Wallet itself is a general-purpose computer that can just &quot;do&quot; anything.</p>
<p>This is where <strong>Instruction Execution (CPI)</strong> comes in. At its core, your Goki Smart Wallet doesn&#x27;t directly perform actions like sending SOL or modifying accounts. Instead, it acts as a powerful signer that can authorize and execute instructions from <em>other</em> Solana programs on its behalf.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-ceo-and-their-departments">The CEO and Their Departments<a href="#the-ceo-and-their-departments" class="hash-link" aria-label="Direct link to The CEO and Their Departments" title="Direct link to The CEO and Their Departments">​</a></h2>
<p>Imagine a busy CEO (your Goki Smart Wallet) who needs many different tasks done: sending money, creating new projects, or hiring new staff. The CEO doesn&#x27;t do all these tasks themselves. Instead, they have specialized departments (other Solana programs) for each job:</p>
<ul>
<li>The &quot;Finance Department&quot; (Solana System Program) for sending SOL.</li>
<li>The &quot;Token Department&quot; (Solana SPL Token Program) for managing tokens.</li>
<li>And so on.</li>
</ul>
<p>When the CEO wants something done, they write a clear request (an &quot;instruction&quot;) and then digitally <em>sign</em> it with their authority, handing it over to the correct department. The department then performs the task, knowing it has the CEO&#x27;s official approval.</p>
<p>On Solana, this delegation of tasks is achieved through <strong>Cross-Program Invocation (CPI)</strong>. Your Goki Smart Wallet Program can &quot;call&quot; another program, digitally signing the instruction with its own authority (or the authority of one of its derived addresses). It&#x27;s like a central command center delegating tasks to specialized departments while maintaining overall control.</p>
<p><strong>What problem does it solve?</strong> It allows your Goki Smart Wallet to interact with any other program on Solana. The Smart Wallet itself only needs to know <em>how to delegate</em>, not <em>how to perform every single blockchain operation</em>. This makes it incredibly flexible and powerful, as it can manage anything that Solana programs can do.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-concepts-delegating-with-authority">Key Concepts: Delegating with Authority<a href="#key-concepts-delegating-with-authority" class="hash-link" aria-label="Direct link to Key Concepts: Delegating with Authority" title="Direct link to Key Concepts: Delegating with Authority">​</a></h2>
<p>Let&#x27;s break down how CPI works in the context of your Goki Smart Wallet:</p>
<table><thead><tr><th style="text-align:left">Concept</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><strong>Cross-Program Invocation (CPI)</strong></td><td style="text-align:left">The act of one Solana program calling or &quot;invoking&quot; another Solana program. It&#x27;s how programs interact and build on top of each other.</td></tr><tr><td style="text-align:left"><strong>Delegation</strong></td><td style="text-align:left">The Smart Wallet doesn&#x27;t execute the final action itself. It delegates the task to the specific program designed to perform that action (e.g., the System Program for transfers).</td></tr><tr><td style="text-align:left"><strong>Signing Authority</strong></td><td style="text-align:left">Crucially, when the Smart Wallet delegates, it also provides its own digital &quot;signature&quot; (or the signature of one of its <a href="/doc_goki/docs/program-derived-addresses-pdas">Program Derived Addresses (PDAs)</a>). This signature gives the delegated instruction the authority of the Smart Wallet, allowing it to spend SOL from the Smart Wallet, or change settings for accounts owned by the Smart Wallet.</td></tr><tr><td style="text-align:left"><strong>Instructions (from other programs)</strong></td><td style="text-align:left">The actions stored in the <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a> are not Goki&#x27;s own instructions. They are standard Solana <code>TransactionInstruction</code> objects meant for <em>other</em> programs. For example, <code>SystemProgram.transfer</code> is an instruction for the Solana System Program.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-the-smart-wallet-uses-cpi-for-execution">How the Smart Wallet Uses CPI for Execution<a href="#how-the-smart-wallet-uses-cpi-for-execution" class="hash-link" aria-label="Direct link to How the Smart Wallet Uses CPI for Execution" title="Direct link to How the Smart Wallet Uses CPI for Execution">​</a></h2>
<p>Recall the <code>executeTransaction</code> function from your <a href="/doc_goki/docs/smart-wallet-wrapper">SmartWalletWrapper</a>. This is where CPI happens.</p>
<p>When you call <code>executeTransaction</code>, here&#x27;s how the Smart Wallet uses CPI:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-proposing-a-transaction-with-an-external-instruction">1. Proposing a Transaction with an External Instruction<a href="#1-proposing-a-transaction-with-an-external-instruction" class="hash-link" aria-label="Direct link to 1. Proposing a Transaction with an External Instruction" title="Direct link to 1. Proposing a Transaction with an External Instruction">​</a></h3>
<p>First, you define an instruction for another program. For example, to send SOL, you use <code>SystemProgram.transfer</code>, which is an instruction for the Solana System Program:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> SystemProgram </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@solana/web3.js&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Assume smartWalletWrapper is already set up from Chapter 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> recipient </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Keypair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">generate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publicKey</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> amountToSend </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LAMPORTS_PER_SOL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This instruction is for the Solana System Program!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> transferInstruction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SystemProgram</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fromPubkey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> smartWalletWrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Smart Wallet is the sender</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  toPubkey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> recipient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lamports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> amountToSend</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Propose the transaction, storing the SystemProgram.transfer instruction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> transactionKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> proposeTx </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> smartWalletWrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proposer</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ownerA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publicKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instructions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">transferInstruction</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// This is what gets stored</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proposeTx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ownerA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> proposeTx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">confirm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Transfer transaction proposed. ID:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transactionKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toBase58</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><em>Explanation</em>: The <code>transferInstruction</code> is a standard Solana instruction telling the <code>SystemProgram</code> to move SOL. When <code>newTransaction</code> is called, this instruction (including its <code>programId</code>, <code>keys</code>, and <code>data</code>) is stored inside the <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a> on the blockchain.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-executing-the-transaction-cpi-in-action">2. Executing the Transaction (CPI in Action)<a href="#2-executing-the-transaction-cpi-in-action" class="hash-link" aria-label="Direct link to 2. Executing the Transaction (CPI in Action)" title="Direct link to 2. Executing the Transaction (CPI in Action)">​</a></h3>
<p>Once enough <a href="/doc_goki/docs/owners-threshold">Owners &amp; Threshold</a> are met and any <a href="/doc_goki/docs/timelock">Timelock</a> has passed, you call <code>executeTransaction</code>. This is when the Smart Wallet performs CPI.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ... (previous code for transactionKey)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Execute the transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> smartWalletWrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transactionKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    owner</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ownerA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publicKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSigners</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ownerA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">confirm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Transaction executed successfully!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// At this point, the Smart Wallet has delegated to the SystemProgram,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// and 0.1 SOL has been sent to the recipient!</span><br></span></code></pre></div></div>
<p><em>Explanation</em>: When <code>executeTransaction</code> is confirmed, the <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a> on the blockchain retrieves the <code>transferInstruction</code> from the <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a>. It then performs a CPI call, telling the Solana runtime: &quot;Hey, System Program! Please execute this <code>transferInstruction</code>, and let me, the Smart Wallet, sign for it!&quot; The System Program then performs the transfer, decrementing the SOL balance of the Smart Wallet.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="under-the-hood-cpi-in-the-smart-wallet-program">Under the Hood: CPI in the Smart Wallet Program<a href="#under-the-hood-cpi-in-the-smart-wallet-program" class="hash-link" aria-label="Direct link to Under the Hood: CPI in the Smart Wallet Program" title="Direct link to Under the Hood: CPI in the Smart Wallet Program">​</a></h2>
<p>The actual CPI magic happens within the <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a>&#x27;s <code>execute_transaction</code> function (or <code>execute_transaction_derived</code>, for <a href="/doc_goki/docs/program-derived-addresses-pdas">PDAs</a>).</p>
<p>Here&#x27;s a simplified view of the flow:</p>
<div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant SmartWalletWrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant SolanaNetwork</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant SmartWalletProgram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant TransactionStateAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant OtherProgram as System Program (or other)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User-&gt;&gt;SmartWalletWrapper: 1. Call executeTransaction()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SmartWalletWrapper-&gt;&gt;SolanaNetwork: 2. Send &#x27;execute_transaction&#x27; instruction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SolanaNetwork-&gt;&gt;SmartWalletProgram: 3. Invoke Smart Wallet Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SmartWalletProgram-&gt;&gt;TransactionStateAccount: 4. Read instructions, approvals, ETA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over SmartWalletProgram: 5. Verify threshold &amp; timelock conditions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SmartWalletProgram-&gt;&gt;OtherProgram: 6. CPI: Invoke Program&lt;br&gt;(with Smart Wallet&#x27;s signature)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OtherProgram--&gt;&gt;SmartWalletProgram: 7. Execute instruction &amp; return result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SmartWalletProgram-&gt;&gt;TransactionStateAccount: 8. Mark transaction as executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionStateAccount--&gt;&gt;SmartWalletProgram: 9. Status updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SmartWalletProgram--&gt;&gt;SolanaNetwork: 10. Acknowledge completion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SolanaNetwork--&gt;&gt;SmartWalletWrapper: 11. Confirmation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SmartWalletWrapper--&gt;&gt;User: 12. Return result</span><br></span></code></pre></div></div>
<p><em>Explanation</em>:</p>
<ol>
<li><strong>User Initiates</strong>: You call <code>executeTransaction</code> on your <code>smartWalletWrapper</code>.</li>
<li><strong>Instruction to Network</strong>: The <code>SmartWalletWrapper</code> prepares an <code>execute_transaction</code> instruction for the <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a> and sends it to the Solana network.</li>
<li><strong>Program Invoked</strong>: The Solana network routes this instruction to the <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a>.</li>
<li><strong>Read Transaction</strong>: The <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a> fetches the details of the proposed transaction from its <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a>.</li>
<li><strong>Checks &amp; Balances</strong>: It verifies that enough owners have approved (meeting the <a href="/doc_goki/docs/owners-threshold">Threshold</a>) and that the <a href="/doc_goki/docs/timelock">Timelock</a> (ETA) has passed. If these conditions are not met, the transaction fails here.</li>
<li><strong>CPI Call (<code>invoke_signed</code>)</strong>: If all checks pass, the <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a> takes the <code>instructions</code> stored in the <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a>. For <em>each</em> of these instructions, it makes a special <strong>CPI call</strong> using a Solana function called <code>invoke_signed</code>. This function tells the Solana runtime to execute the instruction <em>as if the Smart Wallet itself (or one of its <a href="/doc_goki/docs/program-derived-addresses-pdas">Program Derived Addresses (PDAs)</a>) had directly signed it</em>.</li>
<li><strong>Other Program Acts</strong>: The target program (e.g., System Program) receives this CPI-invoked instruction, recognizes the Smart Wallet&#x27;s signature, and performs the requested action (e.g., transfers SOL).</li>
<li><strong>Program Finalizes</strong>: After all delegated instructions are successfully executed, the <a href="/doc_goki/docs/smart-wallet-program">Smart Wallet Program</a> marks the <a href="/doc_goki/docs/transaction-state-account">Transaction State Account</a> as executed.</li>
<li><strong>Confirmation</strong>: The Solana network confirms the overall transaction, and the result is returned to your <code>SmartWalletWrapper</code> and then to your application.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p><strong>Instruction Execution (CPI)</strong> is how your Goki Smart Wallet, acting as a powerful central authority, delegates tasks to other specialized programs on the Solana blockchain. By digitally signing these delegated instructions with its own authority (often through a PDA), the Smart Wallet can perform a wide range of actions, from sending SOL to managing tokens, all under the strict multi-signature and timelock rules you define. This mechanism makes Goki incredibly flexible and a true &quot;smart&quot; wallet.</p>
<p>In the next chapter, we will take a closer look at <a href="/doc_goki/docs/program-derived-addresses-pdas">Program Derived Addresses (PDAs)</a>, the special types of addresses frequently used by programs like Goki to sign for CPI calls and manage assets on the blockchain without needing a private key.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/stayrar3/doc_goki/tree/main/docs/instruction-execution-cpi.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/doc_goki/docs/transaction-state-account"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Transaction State Account</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/doc_goki/docs/program-derived-addresses-pdas"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Program Derived Addresses (PDAs)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-ceo-and-their-departments" class="table-of-contents__link toc-highlight">The CEO and Their Departments</a></li><li><a href="#key-concepts-delegating-with-authority" class="table-of-contents__link toc-highlight">Key Concepts: Delegating with Authority</a></li><li><a href="#how-the-smart-wallet-uses-cpi-for-execution" class="table-of-contents__link toc-highlight">How the Smart Wallet Uses CPI for Execution</a><ul><li><a href="#1-proposing-a-transaction-with-an-external-instruction" class="table-of-contents__link toc-highlight">1. Proposing a Transaction with an External Instruction</a></li><li><a href="#2-executing-the-transaction-cpi-in-action" class="table-of-contents__link toc-highlight">2. Executing the Transaction (CPI in Action)</a></li></ul></li><li><a href="#under-the-hood-cpi-in-the-smart-wallet-program" class="table-of-contents__link toc-highlight">Under the Hood: CPI in the Smart Wallet Program</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/doc_goki/docs/intro">Documentation</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/GokiProtocol/goki" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Goki Documentation. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>