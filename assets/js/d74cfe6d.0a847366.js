"use strict";(self.webpackChunkdocusaurus_site=self.webpackChunkdocusaurus_site||[]).push([[8598],{6877:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"instruction-execution-cpi","title":"Instruction Execution (CPI)","description":"Welcome back, Goki explorers! In our previous chapter, Transaction State Account, we learned that the Smart Wallet Program stores all the details of a proposed transaction, including the actual instructions to be performed, in a special Transaction State Account. But how does the Smart Wallet actually perform those instructions? It\'s not like the Smart Wallet itself is a general-purpose computer that can just \\"do\\" anything.","source":"@site/docs/instruction-execution-cpi.md","sourceDirName":".","slug":"/instruction-execution-cpi","permalink":"/doc_goki/docs/instruction-execution-cpi","draft":false,"unlisted":false,"editUrl":"https://github.com/stayrar3/doc_goki/tree/main/docs/instruction-execution-cpi.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"Transaction State Account","permalink":"/doc_goki/docs/transaction-state-account"},"next":{"title":"Program Derived Addresses (PDAs)","permalink":"/doc_goki/docs/program-derived-addresses-pdas"}}');var a=n(4848),s=n(8453);const o={sidebar_position:8},i="Instruction Execution (CPI)",l={},c=[{value:"The CEO and Their Departments",id:"the-ceo-and-their-departments",level:2},{value:"Key Concepts: Delegating with Authority",id:"key-concepts-delegating-with-authority",level:2},{value:"How the Smart Wallet Uses CPI for Execution",id:"how-the-smart-wallet-uses-cpi-for-execution",level:2},{value:"1. Proposing a Transaction with an External Instruction",id:"1-proposing-a-transaction-with-an-external-instruction",level:3},{value:"2. Executing the Transaction (CPI in Action)",id:"2-executing-the-transaction-cpi-in-action",level:3},{value:"Under the Hood: CPI in the Smart Wallet Program",id:"under-the-hood-cpi-in-the-smart-wallet-program",level:2},{value:"Conclusion",id:"conclusion",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"instruction-execution-cpi",children:"Instruction Execution (CPI)"})}),"\n",(0,a.jsxs)(t.p,{children:["Welcome back, Goki explorers! In our previous chapter, ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"}),", we learned that the Smart Wallet Program stores all the details of a proposed transaction, including the actual instructions to be performed, in a special ",(0,a.jsx)(t.code,{children:"Transaction State Account"}),". But how does the Smart Wallet actually ",(0,a.jsx)(t.em,{children:"perform"}),' those instructions? It\'s not like the Smart Wallet itself is a general-purpose computer that can just "do" anything.']}),"\n",(0,a.jsxs)(t.p,{children:["This is where ",(0,a.jsx)(t.strong,{children:"Instruction Execution (CPI)"})," comes in. At its core, your Goki Smart Wallet doesn't directly perform actions like sending SOL or modifying accounts. Instead, it acts as a powerful signer that can authorize and execute instructions from ",(0,a.jsx)(t.em,{children:"other"})," Solana programs on its behalf."]}),"\n",(0,a.jsx)(t.h2,{id:"the-ceo-and-their-departments",children:"The CEO and Their Departments"}),"\n",(0,a.jsx)(t.p,{children:"Imagine a busy CEO (your Goki Smart Wallet) who needs many different tasks done: sending money, creating new projects, or hiring new staff. The CEO doesn't do all these tasks themselves. Instead, they have specialized departments (other Solana programs) for each job:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:'The "Finance Department" (Solana System Program) for sending SOL.'}),"\n",(0,a.jsx)(t.li,{children:'The "Token Department" (Solana SPL Token Program) for managing tokens.'}),"\n",(0,a.jsx)(t.li,{children:"And so on."}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:['When the CEO wants something done, they write a clear request (an "instruction") and then digitally ',(0,a.jsx)(t.em,{children:"sign"})," it with their authority, handing it over to the correct department. The department then performs the task, knowing it has the CEO's official approval."]}),"\n",(0,a.jsxs)(t.p,{children:["On Solana, this delegation of tasks is achieved through ",(0,a.jsx)(t.strong,{children:"Cross-Program Invocation (CPI)"}),'. Your Goki Smart Wallet Program can "call" another program, digitally signing the instruction with its own authority (or the authority of one of its derived addresses). It\'s like a central command center delegating tasks to specialized departments while maintaining overall control.']}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.strong,{children:"What problem does it solve?"})," It allows your Goki Smart Wallet to interact with any other program on Solana. The Smart Wallet itself only needs to know ",(0,a.jsx)(t.em,{children:"how to delegate"}),", not ",(0,a.jsx)(t.em,{children:"how to perform every single blockchain operation"}),". This makes it incredibly flexible and powerful, as it can manage anything that Solana programs can do."]}),"\n",(0,a.jsx)(t.h2,{id:"key-concepts-delegating-with-authority",children:"Key Concepts: Delegating with Authority"}),"\n",(0,a.jsx)(t.p,{children:"Let's break down how CPI works in the context of your Goki Smart Wallet:"}),"\n",(0,a.jsxs)(t.table,{children:[(0,a.jsx)(t.thead,{children:(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.th,{style:{textAlign:"left"},children:"Concept"}),(0,a.jsx)(t.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,a.jsxs)(t.tbody,{children:[(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{style:{textAlign:"left"},children:(0,a.jsx)(t.strong,{children:"Cross-Program Invocation (CPI)"})}),(0,a.jsx)(t.td,{style:{textAlign:"left"},children:'The act of one Solana program calling or "invoking" another Solana program. It\'s how programs interact and build on top of each other.'})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{style:{textAlign:"left"},children:(0,a.jsx)(t.strong,{children:"Delegation"})}),(0,a.jsx)(t.td,{style:{textAlign:"left"},children:"The Smart Wallet doesn't execute the final action itself. It delegates the task to the specific program designed to perform that action (e.g., the System Program for transfers)."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{style:{textAlign:"left"},children:(0,a.jsx)(t.strong,{children:"Signing Authority"})}),(0,a.jsxs)(t.td,{style:{textAlign:"left"},children:['Crucially, when the Smart Wallet delegates, it also provides its own digital "signature" (or the signature of one of its ',(0,a.jsx)(t.a,{href:"program-derived-addresses-pdas",children:"Program Derived Addresses (PDAs)"}),"). This signature gives the delegated instruction the authority of the Smart Wallet, allowing it to spend SOL from the Smart Wallet, or change settings for accounts owned by the Smart Wallet."]})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{style:{textAlign:"left"},children:(0,a.jsx)(t.strong,{children:"Instructions (from other programs)"})}),(0,a.jsxs)(t.td,{style:{textAlign:"left"},children:["The actions stored in the ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"})," are not Goki's own instructions. They are standard Solana ",(0,a.jsx)(t.code,{children:"TransactionInstruction"})," objects meant for ",(0,a.jsx)(t.em,{children:"other"})," programs. For example, ",(0,a.jsx)(t.code,{children:"SystemProgram.transfer"})," is an instruction for the Solana System Program."]})]})]})]}),"\n",(0,a.jsx)(t.h2,{id:"how-the-smart-wallet-uses-cpi-for-execution",children:"How the Smart Wallet Uses CPI for Execution"}),"\n",(0,a.jsxs)(t.p,{children:["Recall the ",(0,a.jsx)(t.code,{children:"executeTransaction"})," function from your ",(0,a.jsx)(t.a,{href:"smart-wallet-wrapper",children:"SmartWalletWrapper"}),". This is where CPI happens."]}),"\n",(0,a.jsxs)(t.p,{children:["When you call ",(0,a.jsx)(t.code,{children:"executeTransaction"}),", here's how the Smart Wallet uses CPI:"]}),"\n",(0,a.jsx)(t.h3,{id:"1-proposing-a-transaction-with-an-external-instruction",children:"1. Proposing a Transaction with an External Instruction"}),"\n",(0,a.jsxs)(t.p,{children:["First, you define an instruction for another program. For example, to send SOL, you use ",(0,a.jsx)(t.code,{children:"SystemProgram.transfer"}),", which is an instruction for the Solana System Program:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-typescript",children:'import { SystemProgram } from "@solana/web3.js";\n// Assume smartWalletWrapper is already set up from Chapter 1\n\nconst recipient = Keypair.generate().publicKey;\nconst amountToSend = 0.1 * LAMPORTS_PER_SOL;\n\n// This instruction is for the Solana System Program!\nconst transferInstruction = SystemProgram.transfer({\n  fromPubkey: smartWalletWrapper.key, // Smart Wallet is the sender\n  toPubkey: recipient,\n  lamports: amountToSend,\n});\n\n// Propose the transaction, storing the SystemProgram.transfer instruction\nconst { transactionKey, tx: proposeTx } =\n  await smartWalletWrapper.newTransaction({\n    proposer: ownerA.publicKey,\n    instructions: [transferInstruction], // This is what gets stored\n  });\nproposeTx.signers.push(ownerA);\nawait proposeTx.confirm();\nconsole.log("Transfer transaction proposed. ID:", transactionKey.toBase58());\n'})}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.em,{children:"Explanation"}),": The ",(0,a.jsx)(t.code,{children:"transferInstruction"})," is a standard Solana instruction telling the ",(0,a.jsx)(t.code,{children:"SystemProgram"})," to move SOL. When ",(0,a.jsx)(t.code,{children:"newTransaction"})," is called, this instruction (including its ",(0,a.jsx)(t.code,{children:"programId"}),", ",(0,a.jsx)(t.code,{children:"keys"}),", and ",(0,a.jsx)(t.code,{children:"data"}),") is stored inside the ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"})," on the blockchain."]}),"\n",(0,a.jsx)(t.h3,{id:"2-executing-the-transaction-cpi-in-action",children:"2. Executing the Transaction (CPI in Action)"}),"\n",(0,a.jsxs)(t.p,{children:["Once enough ",(0,a.jsx)(t.a,{href:"owners-threshold",children:"Owners & Threshold"})," are met and any ",(0,a.jsx)(t.a,{href:"timelock",children:"Timelock"})," has passed, you call ",(0,a.jsx)(t.code,{children:"executeTransaction"}),". This is when the Smart Wallet performs CPI."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-typescript",children:'// ... (previous code for transactionKey)\n\n// Execute the transaction\nawait smartWalletWrapper\n  .executeTransaction({\n    transactionKey,\n    owner: ownerA.publicKey,\n  })\n  .addSigners(ownerA)\n  .confirm();\nconsole.log("Transaction executed successfully!");\n// At this point, the Smart Wallet has delegated to the SystemProgram,\n// and 0.1 SOL has been sent to the recipient!\n'})}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.em,{children:"Explanation"}),": When ",(0,a.jsx)(t.code,{children:"executeTransaction"})," is confirmed, the ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"})," on the blockchain retrieves the ",(0,a.jsx)(t.code,{children:"transferInstruction"})," from the ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"}),'. It then performs a CPI call, telling the Solana runtime: "Hey, System Program! Please execute this ',(0,a.jsx)(t.code,{children:"transferInstruction"}),', and let me, the Smart Wallet, sign for it!" The System Program then performs the transfer, decrementing the SOL balance of the Smart Wallet.']}),"\n",(0,a.jsx)(t.h2,{id:"under-the-hood-cpi-in-the-smart-wallet-program",children:"Under the Hood: CPI in the Smart Wallet Program"}),"\n",(0,a.jsxs)(t.p,{children:["The actual CPI magic happens within the ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"}),"'s ",(0,a.jsx)(t.code,{children:"execute_transaction"})," function (or ",(0,a.jsx)(t.code,{children:"execute_transaction_derived"}),", for ",(0,a.jsx)(t.a,{href:"program-derived-addresses-pdas",children:"PDAs"}),")."]}),"\n",(0,a.jsx)(t.p,{children:"Here's a simplified view of the flow:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-mermaid",children:"sequenceDiagram\n    participant User\n    participant SmartWalletWrapper\n    participant SolanaNetwork\n    participant SmartWalletProgram\n    participant TransactionStateAccount\n    participant OtherProgram as System Program (or other)\n\n    User->>SmartWalletWrapper: 1. Call executeTransaction()\n    SmartWalletWrapper->>SolanaNetwork: 2. Send 'execute_transaction' instruction\n    SolanaNetwork->>SmartWalletProgram: 3. Invoke Smart Wallet Program\n    SmartWalletProgram->>TransactionStateAccount: 4. Read instructions, approvals, ETA\n    Note over SmartWalletProgram: 5. Verify threshold & timelock conditions\n    SmartWalletProgram->>OtherProgram: 6. CPI: Invoke Program<br>(with Smart Wallet's signature)\n    OtherProgram--\x3e>SmartWalletProgram: 7. Execute instruction & return result\n    SmartWalletProgram->>TransactionStateAccount: 8. Mark transaction as executed\n    TransactionStateAccount--\x3e>SmartWalletProgram: 9. Status updated\n    SmartWalletProgram--\x3e>SolanaNetwork: 10. Acknowledge completion\n    SolanaNetwork--\x3e>SmartWalletWrapper: 11. Confirmation\n    SmartWalletWrapper--\x3e>User: 12. Return result\n"})}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.em,{children:"Explanation"}),":"]}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"User Initiates"}),": You call ",(0,a.jsx)(t.code,{children:"executeTransaction"})," on your ",(0,a.jsx)(t.code,{children:"smartWalletWrapper"}),"."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Instruction to Network"}),": The ",(0,a.jsx)(t.code,{children:"SmartWalletWrapper"})," prepares an ",(0,a.jsx)(t.code,{children:"execute_transaction"})," instruction for the ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"})," and sends it to the Solana network."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Program Invoked"}),": The Solana network routes this instruction to the ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"}),"."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Read Transaction"}),": The ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"})," fetches the details of the proposed transaction from its ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"}),"."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Checks & Balances"}),": It verifies that enough owners have approved (meeting the ",(0,a.jsx)(t.a,{href:"owners-threshold",children:"Threshold"}),") and that the ",(0,a.jsx)(t.a,{href:"timelock",children:"Timelock"})," (ETA) has passed. If these conditions are not met, the transaction fails here."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsxs)(t.strong,{children:["CPI Call (",(0,a.jsx)(t.code,{children:"invoke_signed"}),")"]}),": If all checks pass, the ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"})," takes the ",(0,a.jsx)(t.code,{children:"instructions"})," stored in the ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"}),". For ",(0,a.jsx)(t.em,{children:"each"})," of these instructions, it makes a special ",(0,a.jsx)(t.strong,{children:"CPI call"})," using a Solana function called ",(0,a.jsx)(t.code,{children:"invoke_signed"}),". This function tells the Solana runtime to execute the instruction ",(0,a.jsxs)(t.em,{children:["as if the Smart Wallet itself (or one of its ",(0,a.jsx)(t.a,{href:"program-derived-addresses-pdas",children:"Program Derived Addresses (PDAs)"}),") had directly signed it"]}),"."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Other Program Acts"}),": The target program (e.g., System Program) receives this CPI-invoked instruction, recognizes the Smart Wallet's signature, and performs the requested action (e.g., transfers SOL)."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Program Finalizes"}),": After all delegated instructions are successfully executed, the ",(0,a.jsx)(t.a,{href:"smart-wallet-program",children:"Smart Wallet Program"})," marks the ",(0,a.jsx)(t.a,{href:"transaction-state-account",children:"Transaction State Account"})," as executed."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.strong,{children:"Confirmation"}),": The Solana network confirms the overall transaction, and the result is returned to your ",(0,a.jsx)(t.code,{children:"SmartWalletWrapper"})," and then to your application."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.strong,{children:"Instruction Execution (CPI)"}),' is how your Goki Smart Wallet, acting as a powerful central authority, delegates tasks to other specialized programs on the Solana blockchain. By digitally signing these delegated instructions with its own authority (often through a PDA), the Smart Wallet can perform a wide range of actions, from sending SOL to managing tokens, all under the strict multi-signature and timelock rules you define. This mechanism makes Goki incredibly flexible and a true "smart" wallet.']}),"\n",(0,a.jsxs)(t.p,{children:["In the next chapter, we will take a closer look at ",(0,a.jsx)(t.a,{href:"program-derived-addresses-pdas",children:"Program Derived Addresses (PDAs)"}),", the special types of addresses frequently used by programs like Goki to sign for CPI calls and manage assets on the blockchain without needing a private key."]})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>i});var r=n(6540);const a={},s=r.createContext(a);function o(e){const t=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);